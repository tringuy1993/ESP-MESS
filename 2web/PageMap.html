<!DOCTYPE html>

<html>
    <head>
        <title> Map </title>
        <!-- <link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
        <script src="./lib/leaflet/leaflet.js"></script> -->

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        <link rel="stylesheet" href="./icon/icon.css" />
        <script src="./js/3Modules/ModMap.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
        <script src="./lib/leaflet/leaflet-offline.js"></script>
        <script src="./lib/leaflet/FileSaver.js"></script>
    </head>
    <body>
        <h1> This is Map </h1>

        <button id="saveFilesButton">Save Files to Local</button>
        <div id="map" style="width: 1000px; height: 700px;">
        </div>

        <script>
            // Create LeafletMap2 object
            const leafletMap = new LeafletMapObject();

            // Show Map
            leafletMap.showMap();
            leafletMap.addMarkers();

            leafletMap.addPoly([
                [41.11424347875406, -85.141370068531], 
                [41.114522240234045, -85.1407831633786], 
                [41.11379649666884, -85.14017712001473],
                [41.113522538402634, -85.1407831633786]
            ])

            leafletMap.addPoly([
                [41.114522240234045, -85.1407831633786], 
                [41.11379649666884, -85.14017712001473],
                [41.114329573082095, -85.13922564818678],
                [41.11473538016774, -85.13928633964616],
                [41.11470680228608, -85.14030292159106],
            ], '#CA6F1E')

            leafletMap.addPoly([
                [41.11473538016774, -85.13928633964616],
                [41.11470680228608, -85.14030292159106],
                [41.115712736241136, -85.14033326731644],
                [41.11570702075089, -85.13929392607427],
            ], '#27AE60')

            leafletMap.addPoly([
                [41.114198113919635, -85.13944565472276],
                [41.11352366707468, -85.13895253661515],
                [41.1135408141142, -85.1382242391024],
                [41.11451247236969, -85.13828493056181],
                [41.11451818796393, -85.13926358034458]
            ], '#D0D3D4')

            leafletMap.addPoly([
                [41.11451818796393, -85.13926358034458],
                [41.11452961915095, -85.13794354110269],
                [41.11515740417247, -85.13797501645811],
                [41.115184592002294, -85.13926513949474]
            ], '#F1C40F')

            leafletMap.addPoly([
                [41.115184592002294, -85.13926513949474],
                [41.115721549343505, -85.13920198662822],
                [41.115755533848564, -85.13970720967954],
                [41.1166527181203, -85.13977036251626],
                [41.116656116521426, -85.1393779124994],
                [41.116346861225345, -85.1393734015797], //! Edge
                [41.116343462809155, -85.13876442738653], //! Edge
                [41.116894004221024, -85.1387869819851],
                [41.11673767811671, -85.13759158826235],
                [41.115235569168355, -85.13758256641437]
            ], '#34495E')

            leafletMap.addPoly([
                [41.115755533848564, -85.13970720967954],
                [41.115706450466774, -85.14176490904838],
                [41.11616863817672, -85.14176490904838],
                [41.11623660668311, -85.13978010437664]
            ], '#E59866')

            leafletMap.addPoly([
                [41.116346861225345, -85.1393734015797], //! Edge
                [41.116343462809155, -85.13876442738653], //! Edge
                [41.116894004221024, -85.1387869819851],
                [41.116889100763764, -85.13938314344232]
            ], '#DFFF00')

            leafletMap.addPoly([
                [41.11555012153385, -85.13754268816184], //! Edge
                [41.11557730920106, -85.13669463525666], //! Edge
                [41.116610432209946, -85.13673072261432],
                [41.116586736199686, -85.13753854388189]
            ], '#DE3163')
        </script>

        <script>

            //Save Data to Text File as a backup just incase the database is corrupted on client side.
            document.getElementById('saveFilesButton').addEventListener('click', function() {
                let db;
                let openRequest = indexedDB.open("leaflet.offline");
                openRequest.onsuccess = function(e) {
                    db = e.target.result;
                    let transaction = db.transaction('tileStore');
                    let store = transaction.objectStore('tileStore');
                    let request = store.getAll();

                    request.onsuccess = function(e) {
                        let data = JSON.stringify(e.target.result);
                        let blob = new Blob([data], {type: 'application/json'});

                        let date = new Date();
                        let dateString = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
                        saveAs(blob, `${dateString}_data.txt`)
                    }
                }
            })
        </script>
    </body>
</html>